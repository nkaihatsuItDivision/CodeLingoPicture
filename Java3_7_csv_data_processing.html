<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVデータ処理の構造説明図 - Java Week3 Lesson7</title>
    <style>
        body {
            font-family: 'Hiragino Sans', 'Yu Gothic', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2d3436 0%, #636e72 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        .header p {
            margin: 10px 0 0 0;
            font-size: 16px;
            opacity: 0.9;
        }

        .section {
            padding: 30px;
            border-bottom: 1px solid #ecf0f1;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 25px;
            text-align: center;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .method-box {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            background: #f8f9fa;
        }

        .basic-method {
            border-color: #e74c3c;
        }

        .safe-method {
            border-color: #27ae60;
        }

        .method-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .basic-method .method-title {
            color: #e74c3c;
        }

        .safe-method .method-title {
            color: #27ae60;
        }

        .csv-sample {
            background: #2d3436;
            color: #ddd;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin: 15px 0;
            overflow-x: auto;
            position: relative;
        }

        .csv-sample::before {
            content: "CSV データ";
            position: absolute;
            top: -12px;
            left: 10px;
            background: #2d3436;
            color: #74b9ff;
            padding: 2px 8px;
            font-size: 11px;
            border-radius: 3px;
        }

        .highlighted-comma {
            background: #e74c3c;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .safe-comma {
            background: #27ae60;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .quote-highlight {
            background: #f39c12;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: bold;
        }

        .result-box {
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .result-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .result-item {
            background: white;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .error-result {
            border-left-color: #e74c3c;
            background: #fdf2f2;
        }

        .success-result {
            border-left-color: #27ae60;
            background: #f2fdf5;
        }

        .process-flow {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 25px 0;
        }

        .process-step {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }

        .step-number {
            background: #3498db;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .step-description {
            color: #7f8c8d;
            font-size: 14px;
            line-height: 1.4;
        }

        .code-example {
            background: #2d3436;
            color: #ddd;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
            overflow-x: auto;
        }

        .variable {
            color: #74b9ff;
        }

        .string {
            color: #55a3ff;
        }

        .keyword {
            color: #fd79a8;
        }

        .comment {
            color: #636e72;
            font-style: italic;
        }

        .arrow {
            text-align: center;
            font-size: 24px;
            color: #3498db;
            margin: 10px 0;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .legend-color {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        .comma-color { background: #e74c3c; }
        .quote-color { background: #f39c12; }
        .safe-color { background: #27ae60; }

        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-left: 4px solid #fdcb6e;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .warning-title {
            font-weight: bold;
            color: #8b7800;
            margin-bottom: 8px;
        }

        .tip-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .tip-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .section {
                padding: 20px;
            }
            
            .comparison-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .legend {
                gap: 15px;
            }
            
            .process-step {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 CSVデータ処理の構造説明図</h1>
            <p>Java Week 3 Lesson 7 - 安全なCSV分割の仕組みと実装</p>
        </div>

        <!-- 問題の説明 -->
        <div class="section">
            <div class="section-title">🚨 CSVデータ処理の問題点</div>
            
            <div class="csv-sample">
P003<span class="highlighted-comma">,</span><span class="quote-highlight">"</span>高級ボールペン<span class="highlighted-comma">,</span>黒<span class="quote-highlight">"</span><span class="highlighted-comma">,</span>1200<span class="highlighted-comma">,</span>50<span class="highlighted-comma">,</span>文房具
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color comma-color"></div>
                    <span>分割すべきカンマ</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color quote-color"></div>
                    <span>引用符（データの境界）</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color safe-color"></div>
                    <span>保護されたカンマ</span>
                </div>
            </div>

            <div class="comparison-container">
                <div class="method-box basic-method">
                    <div class="method-title">❌ 基本的なsplit()の問題</div>
                    <div class="code-example">
<span class="variable">String</span>[] parts = line.<span class="keyword">split</span>(<span class="string">","</span>);
<span class="comment">// 全てのカンマで分割してしまう</span>
                    </div>
                    <div class="result-box">
                        <div class="result-title">分割結果：</div>
                        <div class="result-item error-result">[0] P003</div>
                        <div class="result-item error-result">[1] "高級ボールペン</div>
                        <div class="result-item error-result">[2] 黒"</div>
                        <div class="result-item error-result">[3] 1200</div>
                        <div class="result-item error-result">[4] 50</div>
                        <div class="result-item error-result">[5] 文房具</div>
                    </div>
                    <div class="warning-box">
                        <div class="warning-title">⚠️ 問題点</div>
                        商品名「高級ボールペン,黒」が[1]と[2]に分割されてしまい、データが破損
                    </div>
                </div>

                <div class="method-box safe-method">
                    <div class="method-title">✅ 安全なparseSafeCSV()の解決</div>
                    <div class="code-example">
<span class="variable">String</span>[] parts = <span class="keyword">parseSafeCSV</span>(line);
<span class="comment">// 引用符を考慮した分割</span>
                    </div>
                    <div class="result-box">
                        <div class="result-title">分割結果：</div>
                        <div class="result-item success-result">[0] P003</div>
                        <div class="result-item success-result">[1] 高級ボールペン,黒</div>
                        <div class="result-item success-result">[2] 1200</div>
                        <div class="result-item success-result">[3] 50</div>
                        <div class="result-item success-result">[4] 文房具</div>
                    </div>
                    <div class="tip-box">
                        <div class="tip-title">💡 解決</div>
                        引用符内のカンマは分割対象外として正しく処理され、データの整合性を保持
                    </div>
                </div>
            </div>
        </div>

        <!-- 処理フローの説明 -->
        <div class="section">
            <div class="section-title">⚙️ parseSafeCSV()メソッドの処理フロー</div>
            
            <div class="process-flow">
                <div class="process-step">
                    <div class="step-number">1</div>
                    <div class="step-content">
                        <div class="step-title">初期化</div>
                        <div class="step-description">ArrayList&lt;String&gt; columns とStringBuilder currentColumn を準備<br>
                        boolean insideQuotes = false で引用符の内外状態を管理</div>
                    </div>
                </div>

                <div class="process-step">
                    <div class="step-number">2</div>
                    <div class="step-content">
                        <div class="step-title">文字列を1文字ずつ処理</div>
                        <div class="step-description">for (int i = 0; i &lt; line.length(); i++) でループ開始<br>
                        char c = line.charAt(i) で現在の文字を取得</div>
                    </div>
                </div>

                <div class="process-step">
                    <div class="step-number">3</div>
                    <div class="step-content">
                        <div class="step-title">引用符の判定</div>
                        <div class="step-description">if (c == '"') → insideQuotes = !insideQuotes<br>
                        引用符が見つかったら内外状態を切り替え（引用符自体は結果に含めない）</div>
                    </div>
                </div>

                <div class="process-step">
                    <div class="step-number">4</div>
                    <div class="step-content">
                        <div class="step-title">カンマの処理</div>
                        <div class="step-description">if (c == ',' && !insideQuotes) → 分割ポイント<br>
                        引用符外のカンマでのみ列を区切り、引用符内のカンマは通常文字として扱う</div>
                    </div>
                </div>

                <div class="process-step">
                    <div class="step-number">5</div>
                    <div class="step-content">
                        <div class="step-title">通常文字の追加</div>
                        <div class="step-description">else → currentColumn.append(c)<br>
                        引用符とカンマ以外の文字は現在の列に追加</div>
                    </div>
                </div>

                <div class="process-step">
                    <div class="step-number">6</div>
                    <div class="step-content">
                        <div class="step-title">最終列の追加</div>
                        <div class="step-description">ループ終了後、最後の列をArrayListに追加<br>
                        return columns.toArray(new String[0]) で配列として返却</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 実装例 -->
        <div class="section">
            <div class="section-title">💻 実装コード例</div>
            
            <div class="code-example">
<span class="keyword">public static</span> <span class="variable">String</span>[] <span class="keyword">parseSafeCSV</span>(<span class="variable">String</span> line) {
    <span class="variable">ArrayList</span>&lt;<span class="variable">String</span>&gt; columns = <span class="keyword">new</span> <span class="variable">ArrayList</span>&lt;&gt;();
    <span class="variable">StringBuilder</span> currentColumn = <span class="keyword">new</span> <span class="variable">StringBuilder</span>();
    <span class="variable">boolean</span> insideQuotes = <span class="keyword">false</span>;
    
    <span class="keyword">for</span> (<span class="variable">int</span> i = <span class="string">0</span>; i &lt; line.<span class="keyword">length</span>(); i++) {
        <span class="variable">char</span> c = line.<span class="keyword">charAt</span>(i);
        
        <span class="keyword">if</span> (c == <span class="string">'"'</span>) {
            insideQuotes = !insideQuotes;  <span class="comment">// 引用符の内外を切り替え</span>
        } <span class="keyword">else if</span> (c == <span class="string">','</span> && !insideQuotes) {
            <span class="comment">// 引用符外のカンマで分割</span>
            columns.<span class="keyword">add</span>(currentColumn.<span class="keyword">toString</span>().<span class="keyword">trim</span>());
            currentColumn = <span class="keyword">new</span> <span class="variable">StringBuilder</span>();
        } <span class="keyword">else</span> {
            currentColumn.<span class="keyword">append</span>(c);
        }
    }
    
    <span class="comment">// 最後の列を追加</span>
    columns.<span class="keyword">add</span>(currentColumn.<span class="keyword">toString</span>().<span class="keyword">trim</span>());
    
    <span class="keyword">return</span> columns.<span class="keyword">toArray</span>(<span class="keyword">new</span> <span class="variable">String</span>[<span class="string">0</span>]);
}
            </div>
        </div>

        <!-- エラーハンドリング -->
        <div class="section">
            <div class="section-title">🛡️ エラーハンドリングと安全性</div>
            
            <div class="comparison-container">
                <div class="method-box">
                    <div class="method-title" style="color: #e67e22;">🔍 考慮すべきケース</div>
                    <div class="result-box">
                        <div class="result-item">空行の処理</div>
                        <div class="result-item">null値の処理</div>
                        <div class="result-item">列数の不一致</div>
                        <div class="result-item">不正な引用符（閉じ忘れ）</div>
                        <div class="result-item">空のフィールド</div>
                    </div>
                </div>

                <div class="method-box">
                    <div class="method-title" style="color: #27ae60;">✅ 対応策</div>
                    <div class="code-example">
<span class="comment">// 安全な列取得</span>
<span class="keyword">public static</span> <span class="variable">String</span> <span class="keyword">getColumnSafe</span>(<span class="variable">String</span>[] columns, <span class="variable">int</span> index) {
    <span class="keyword">if</span> (columns == <span class="keyword">null</span> || index >= columns.<span class="keyword">length</span>) {
        <span class="keyword">return</span> <span class="string">"(未設定)"</span>;
    }
    
    <span class="variable">String</span> value = columns[index];
    <span class="keyword">return</span> (value == <span class="keyword">null</span> || value.<span class="keyword">isEmpty</span>()) ? 
           <span class="string">"(空)"</span> : value;
}
                    </div>
                </div>
            </div>

            <div class="tip-box">
                <div class="tip-title">💡 実用的なポイント</div>
                <ul>
                    <li><strong>段階的処理</strong>：まずは基本機能、次に例外処理を追加</li>
                    <li><strong>防御的プログラミング</strong>：想定外のデータでもエラーを避ける</li>
                    <li><strong>ログ出力</strong>：処理できなかったデータの記録</li>
                    <li><strong>テストデータ</strong>：様々なパターンでの動作確認</li>
                </ul>
            </div>
        </div>

        <!-- まとめ -->
        <div class="section">
            <div class="section-title">🎯 学習のまとめ</div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="warning-box">
                    <div class="warning-title">⚠️ 基本split()の限界</div>
                    単純な文字列分割では、引用符内のカンマを区別できず、データが破損する可能性がある
                </div>
                
                <div class="tip-box">
                    <div class="tip-title">💪 安全な解析の価値</div>
                    parseSafeCSV()により、引用符を考慮した正確なデータ分割が可能となり、実用的なCSV処理を実現
                </div>
            </div>

            <div style="background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                <h3 style="margin: 0 0 10px 0;">🚀 実務での応用</h3>
                <p style="margin: 0; font-size: 16px;">この技術により、Excel出力ファイル、システム連携データ、ログファイルなど、<br>実際のビジネスで扱う複雑なCSVデータを安全に処理できるようになります</p>
            </div>
        </div>
    </div>
</body>
</html>